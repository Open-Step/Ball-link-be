<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Kakao Login & Password Reset Test</title>
</head>
<body>
<h1>Auth Test Page</h1>

<!-- ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ -->
<button onclick="kakaoLogin()">ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸</button>
<p id="tokens"></p>

<hr>

<!-- ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ìš”ì²­ -->
<h3>ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ìš”ì²­</h3>
<input type="email" id="resetEmail" placeholder="ì´ë©”ì¼ ì…ë ¥" />
<button onclick="requestReset()">Reset Password</button>
<p id="resetResponse"></p>

<hr>

<!-- ì´ë©”ì¼ ìˆ˜ì • -->
<h3>ì´ë©”ì¼ ìˆ˜ì •</h3>
<input type="email" id="newEmail" placeholder="ìƒˆ ì´ë©”ì¼ ì…ë ¥" />
<button onclick="updateEmail()">Update Email</button>
<p id="updateEmailResponse"></p>

<hr>

<!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • -->
<h3>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h3>
<input type="text" id="resetToken" placeholder="í† í° ì…ë ¥" />
<input type="password" id="newPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
<button onclick="confirmReset()">Confirm Reset</button>
<p id="confirmResponse"></p>
<script>
    // ==========================
    // ğŸ”‘ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
    // ==========================
    function kakaoLogin() {
        window.location.href =
            "https://kauth.kakao.com/oauth/authorize?response_type=code" +
            "&client_id=a1ea757a34a37aa2e3c994d86259cd40" +
            "&redirect_uri=http://localhost:8080/api/v1/auth/kakao/callback";
    }

    // ==========================
    // ğŸ“¦ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ í† í° ì €ì¥
    // ==========================
    function handleRedirectTokens() {
        const params = new URLSearchParams(window.location.search);
        const at = params.get("accessToken");
        const rt = params.get("refreshToken");

        if (at && rt) {
            localStorage.setItem("accessToken", at);
            localStorage.setItem("refreshToken", rt);
            document.getElementById("tokens").innerText =
                "AccessToken: " + at + "\nRefreshToken: " + rt;

            // âœ… ì£¼ì†Œì°½ì—ì„œ í† í° ì œê±° (ë³´ì•ˆìƒ ê¹”ë”í•˜ê²Œ)
            window.history.replaceState({}, document.title, "/index.html");
        }
    }

    // ==========================
    // ğŸ“¡ ê³µí†µ fetch wrapper
    // ==========================
    async function authorizedFetch(url, options = {}) {
        const token = localStorage.getItem("accessToken");
        const headers = {
            ...(options.headers || {}),
            "Content-Type": "application/json",
        };
        if (token) {
            headers["Authorization"] = "Bearer " + token;
        }

        return fetch(url, {
            ...options,
            headers
        });
    }

    // ==========================
    // ğŸ” ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ìš”ì²­
    // ==========================
    async function requestReset() {
        const email = document.getElementById("resetEmail").value;
        const res = await authorizedFetch("/api/v1/auth/password-reset", {
            method: "POST",
            body: JSON.stringify({ email })
        });

        const data = await res.json();
        document.getElementById("resetResponse").innerText = JSON.stringify(data);
    }

    // ==========================
    // âœ‰ï¸ ì´ë©”ì¼ ìˆ˜ì •
    // ==========================
    async function updateEmail() {
        const newEmail = document.getElementById("newEmail").value;
        const res = await authorizedFetch("/api/v1/user/email", {
            method: "PUT",
            body: JSON.stringify({ email: newEmail })
        });

        if (res.ok) {
            document.getElementById("updateEmailResponse").innerText = "âœ… ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
        } else {
            const err = await res.text();
            document.getElementById("updateEmailResponse").innerText = "âŒ ì‹¤íŒ¨: " + err;
        }
    }
    async function confirmReset() {
        const token = document.getElementById("resetToken").value;
        const newPassword = document.getElementById("newPassword").value;

        const res = await fetch("/api/v1/auth/password-reset/confirm", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, newPassword })
        });

        if (res.ok) {
            document.getElementById("confirmResponse").innerText = "âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.";
        } else {
            const err = await res.text();
            document.getElementById("confirmResponse").innerText = "âŒ ì‹¤íŒ¨: " + err;
        }
    }
    // ==========================
    // ğŸš€ í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    // ==========================
    window.onload = () => {
        handleRedirectTokens();

        const at = localStorage.getItem("accessToken");
        const rt = localStorage.getItem("refreshToken");
        if (at && rt) {
            document.getElementById("tokens").innerText =
                "AccessToken: " + at + "\nRefreshToken: " + rt;
        }
    }
</script>
</body>
</html>
